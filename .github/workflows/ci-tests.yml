name: CI Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
      MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
      DB_HOST: pass-slip-mysql
      DB_PORT: 3306
      DB_NAME: pass_slip_system
      DB_USER: root
      DB_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build and start Docker containers
        run: |
          docker compose up -d

      - name: Wait for MySQL to be ready
        run: |
          echo "Waiting for MySQL to be ready..."
          for i in {1..30}; do
            if docker exec pass-slip-mysql mysqladmin ping -uroot -pgroup2-123 --silent 2>/dev/null; then
              echo "MySQL is ready!"
              sleep 5  # Give it a few more seconds to fully initialize
              break
            fi
            echo "Waiting for MySQL... ($i/30)"
            sleep 2
          done

          # Show MySQL logs for debugging
          echo "=== MySQL Container Logs ==="
          docker logs pass-slip-mysql --tail 50

      - name: Check if containers are running
        run: |
          docker ps
          docker compose ps

      - name: Test database connection
        run: |
          docker exec pass-slip-mysql mysql -uroot -pgroup2-123 -e "SHOW DATABASES;"
          docker exec pass-slip-mysql mysql -uroot -pgroup2-123 pass_slip_system -e "SHOW TABLES;"

      - name: PHP Syntax Check
        run: |
          # Check all PHP files for syntax errors
          docker exec pass-slip-web find /var/www/html -name "*.php" -exec php -l {} \; | grep -v "No syntax errors"

      - name: Test web server is responding
        run: |
          curl -f http://localhost:8080 || exit 1

      - name: Run basic health checks
        run: |
          # Check if Apache is running
          docker exec pass-slip-web service apache2 status

          # Check if MySQL is accessible
          docker exec pass-slip-mysql mysqladmin ping -uroot -pgroup2-123

      - name: View logs on failure
        if: failure()
        run: |
          echo "=== Web Server Logs ==="
          docker logs pass-slip-web
          echo "=== Database Logs ==="
          docker logs pass-slip-mysql

      - name: Stop containers
        if: always()
        run: docker compose down -v
